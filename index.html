<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Awaken - v41.02 - 27NOV25</title>
  <style>
    :root{
      --bg-left-dark: linear-gradient(90deg, rgba(10,10,10,1) 0%, rgba(40,40,40,0.9) 60%);
      --card-bg: #ffffff;
      --card-text: #222;
      --accent-color: #1e90ff;
      --header-height: 60px;
      --accent: #1e90ff;
      --ok: #2e7d32;
      --bad: #b71c1c;
      --orange: #ef6c00;
      --muted: #777;
    }
    html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;}
    body{
      background:
        linear-gradient(to right, rgba(244,244,244,0.97) 60%, rgba(244,244,244,0.85) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center;
      background-size: auto 100% /* üîß cobre toda a tela */
      background-attachment: scroll; /* üîß evita falha em mobile */
      color:var(--card-text);
    }
    body.dark{
      background:
        linear-gradient(to right, rgba(12,12,12,1) 60%, rgba(12,12,12,0.9) 80%, transparent 100%),
        url('https://i.ibb.co/9mWwdssF/chatgpt-jogadoresquestionaveis.png') no-repeat right center;
      background-size: cover;
      background-attachment: scroll;
      color:#eaeaea;
    }
    .page {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      padding: 28px;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .col-left { width:30%; overflow:auto; }
    .col-center { width:50%; overflow:auto; }
    .col-right { width:20%; overflow:auto; border-radius:10px; padding:12px; box-shadow:0 6px 20px rgba(0,0,0,0.08); margin-bottom:12px; }
    @media (min-width: 1001px) {
      .col-left { flex: 0 0 30%; }
      .col-center { flex: 0 0 50%; }
      .col-right { flex: 0 0 15%; }
    }
    @media (max-width:1000px){
      .page { padding: 16px; flex-direction: column; }
      .col-left, .col-center, .col-right { width: 100%; max-width: 100%; display: block; }
    }
    header { height: var(--header-height); display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; background-color: var(--accent-color); color: white; margin-bottom:12px; }
    header h1 { font-size:18px; margin:0; }
    header .brand { color:var(--muted); font-size:13px; }
    .panel { background:var(--card-bg); color:var(--card-text); border-radius:10px; padding:4px; box-shadow:0 6px 20px rgba(0,0,0,0.08); margin-bottom:4px; }
    body.dark .panel { background:#111; color:#eaeaea; box-shadow:none; }
    input[type="text"], input[type="number"], select { padding:4px 6px;border-radius:8px;border:1px solid #ddd; }
    body.dark input[type="text"], body.dark input[type="number"], body.dark select { background:#1b1b1b;border:1px solid #333;color:#eaeaea; }
    .row { display:flex; gap:8px; align-items:center; margin-top:8px; }
    .row .short { width:120px; min-width:80px; }
    button.primary { background:var(--accent); color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer; }
    button.ghost { background:transparent;border:1px solid #ccc;padding:7px 10px;border-radius:8px;color:inherit;cursor:pointer; }
    .team-card { border-radius:10px; overflow:hidden; margin-bottom:12px; background:var(--card-bg); color:var(--card-text); border:1px solid rgba(0,0,0,0.06); }
    body.dark .team-card { background:#111; border:1px solid rgba(255,255,255,0.03); }
    .team-header { display:flex; justify-content:space-between; align-items:center; padding:12px 14px; cursor:pointer; }
    .team-title{ font-weight:700; }
    .team-meta{ color:var(--muted); font-size:13px; }
    .team-badges { display:flex; gap:6px; align-items:center; }
    .team-badge { background:var(--accent); color:#fff; padding:6px 10px;border-radius:999px;font-size:13px;font-weight:700; }
    .team-badge.franchise { background:#1976d2; }
    .team-badge.inj { background:#d32f2f; }
    .team-badge.bye {background:#ff9800; }
    .team-badge.notime { background:ff9800; }
    .team-body { padding:6px 14px; border-top:1px solid rgba(0,0,0,0.04); display:none; }
    body.dark .team-body { border-top:1px solid rgba(255,255,255,0.03); }
    .player-card { display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; margin:8px 0; box-shadow:0 6px 14px rgba(0,0,0,0.06); background:#fafafa; }
    body.dark .player-card { box-shadow:none; background:#151515; }
    .player-left { display:flex; gap:12px; align-items:center; }
    .player-name{ font-weight:700; }
    .player-pos{ color:var(--muted); font-size:13px; }
    .status-pill { padding:6px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:13px; }
    .status-Out { background:#b71c1c; }
    .status-Questionable { background:#FFBF00; }
    .status-Doubtful { background:#FF5C00; }
    .status-IR { background:#6a1b9a; }
    .status-Suspended { background:#424242; }
    .status-Healthy { background:#2e7d32; color:#fff; }
    .empty-pos { background:#f8d7da; color:#7f1d1d; font-weight:700; padding:10px; border-radius:8px; margin-bottom:8px; }
    .players-list .group-title { margin-top:10px; font-weight:700; }
    .copy-btn { cursor:pointer; display:inline-flex; align-items:center; gap:6px; padding:6px; border-radius:6px; border:1px dashed transparent; background:transparent; }
    .copy-tooltip { position:relative; }
    .copy-toast { position:absolute; top:-36px; right:0; background:#111; color:#fff; padding:6px 8px; border-radius:6px; font-size:13px; box-shadow:0 6px 18px rgba(0,0,0,0.2); display:none; }
    body.dark .copy-toast { background:#eaeaea; color:#111; }
    .actions-row { display:flex; gap:8px; margin:10px 0 18px 0; align-items:center; }
    footer { position:fixed; left:0; right:0; bottom:0; background:rgba(255,255,255,0.98); color:#333; padding:10px 18px; box-shadow:0 -6px 30px rgba(0,0,0,0.08); display:flex; justify-content:center; gap:18px; align-items:center; font-size:14px; }
    body.dark footer { background:rgba(10,10,10,0.98); color:#ddd; }
    footer a { color:var(--accent); text-decoration:none; font-weight:700; }
    #debug-log { position:fixed; left:12px; right:12px; bottom:70px; max-height:40vh; overflow:auto; background:rgba(0,0,0,0.85); color:#0f0; font-family:monospace; font-size:12px; padding:10px; border-radius:8px; display:none; z-index:9999; }
    #debug-log pre { white-space:pre-wrap; }

/* ----------------------------------------
   Painel de Updates ‚Äî estilo recolh√≠vel
   ---------------------------------------- */

.updates-card {
  border: 0px solid var(--border, #444);
  border-radius: 12px;
  margin: 12px 0;
 /* overflow: hidden; */
}

/* Cabe√ßalho do painel */
.updates-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 10px 14px;
  font-weight: bold;
  color: #f44336;
  border-bottom: 0px solid #333;
  transition: background 0.2s ease;
}


/* Setinha animada √† direita */
.updates-header::after {
  content: "‚ñ∏";
  font-size: 2rem;
  color: #aaa;
  transition: transform 0.3s ease;
}

/* Quando o painel estiver aberto, a setinha gira para baixo */
.updates-card.open .updates-header::after {
  transform: rotate(90deg);
}

/* Corpo do painel (conte√∫do ocult√°vel) */
.updates-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  opacity: 0;
  padding: 0 8px;
}

.updates-card.open .updates-body {
  max-height: 500px; /* limite suficiente para o conte√∫do */
  opacity: 100;
  padding: 8px 14px 14px 14px;
}

/* Conte√∫do interno */
.updates-body .brand p {
  margin: 6px 0;
  line-height: 1.4;
}


/* ----------------------------------------
   Painel de buscas ‚Äî estilo recolh√≠vel
   ---------------------------------------- */

.buscas-card {
  border: 0px solid var(--border, #444);
  border-radius: 12px;
  margin: 12px 0;
 /* overflow: hidden; */
}

/* Cabe√ßalho do painel */
.buscas-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  padding: 5px 8px;
  border-bottom: 0px solid #333;
  transition: background 0.2s ease;
}


/* Setinha animada √† direita */
.buscas-header::after {
  content: "‚ñ∏";
  font-size: 2rem;
  color: #aaa;
  transition: transform 0.3s ease;
}

/* Quando o painel estiver aberto, a setinha gira para baixo */
.buscas-card.open .buscas-header::after {
  transform: rotate(90deg);
}

/* Corpo do painel (conte√∫do ocult√°vel) */
.buscas-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.4s ease;
  opacity: 0;
  padding: 0 7px;
}

.buscas-card.open .buscas-body {
  max-height: 500px; /* limite suficiente para o conte√∫do */
  opacity: 100;
  padding: 7px 9px 9px 9px;
}

/* Conte√∫do interno */
.buscas-body .brand p {
  margin: 2px 0;
  line-height: 1.1;
}


  </style>
</head>
<body>
  <header>
    <div>
      <h1><img src="https://i.ibb.co/KxQgNLnp/awaken225.png" width="265" height="65" alt="Awaken"></h1>
    </div>
  </header>
  <div class="page">
    <div class="col-left">
	<div class="panel updates-card">
  		<div class="updates-header" onclick="toggleTeamBody(this.parentElement)">
    			<b><p style="color:red; margin:0;"> &#127381; Updates</p></b>
  		</div>
		<div class="updates-body" style="display:none;">
    			<div class="brand">
			 <b>27/NOV</b><br>
					I - Jogos da semana 13 atualizados. <br><br>
			  <b>24/OUT</b><br>
        		  I - As buscas indicam jogadores em bye week.<br>
        		  II - Op√ß√£o ignorar status Questionable.<br>
			  III - Cards laterais em modo retr√°til.<br><br>
      			  <b>21/OUT</b><br> I - Adicionado busca nas ligas Guilhotinha.</br>
      			  <b><p style="color:red;">üîÑ Em breve</p></b>
			  *Procura de jogadores da franquia ir√° refinar posi√ß√µes.<br>
      			  **Scorebox com Proje√ß√£o x Real.
    			</div>
  		</div>
	</div>

	<div class="panel buscas-card">
  		<div class="buscas-header" onclick="toggleTeamBody(this.parentElement)">
    			  <h3>Quem <b>n√£o</b> joga nos meus times?</h3>
  		</div>
		<div class="buscas-body" style="display:block;">
    			<div class="brand">          
			  <input id="username" type="text" placeholder="User Sleeper Ex. MolotovPigs" size="22px" />
          		  <button class="primary" onclick="buscarPorUsuario()">Verificar</button>
			  <div>
			    <label style="cursor:pointer;"><input type="checkbox" id="ignoreQuestionable" checked>Ignorar jogadores "Questionable"</label>
			  </div>
	        	  <div style="color:var(--muted);font-size:13px;margin-top:8px;">
        	  		Exibe <b>titulares</b> com status diferente de Healthy, em Bye Week ou Desempregados nos seus times.
        	  	  </div>
    			</div>
  		</div>
	</div>

      <div class="panel buscas-card">
  		<div class="buscas-header" onclick="toggleTeamBody(this.parentElement)">
    			<h3>Quais os buracos na <b>liga</b> que eu jogo?</h3>
  		</div>
		<div class="buscas-body" style="display:block;">
    			<div class="brand">          
			        <input id="leagueId" type="text" placeholder="League ID (Ex: 1200153826695323648)" />
          			<button class="primary" onclick="buscarPorLiga()">Buscar</button>
        		</div>
			<div><label style="cursor:pointer;">
    				<input type="checkbox" id="ignoreQuestionableLeague" checked>Ignorar jogadores "Questionable"
			</label></div>
        		<div style="color:var(--muted);font-size:13px;margin-top:8px;">
          			Exibe os jogadores n√£o saud√°veis de todos os times na liga pesquisada. <b>Dica:</b> üìã Copie o league id na busca anterior.
        	  	</div>
    		</div>
	</div>

     <div class="panel buscas-card">
  		<div class="buscas-header" onclick="toggleTeamBody(this.parentElement)">
		        <h3>Varredura de <b>Franchise</b> Players</h3>
  		</div>
		<div class="buscas-body" style="display:block;">
    			<div class="brand">          
	          		<input id="franchiseLeagueId" type="text" placeholder="League ID (Ex: 1234...)" size="14px" />
          			<input id="minFranchise" size="4px" type="number" placeholder="‚â• Titulares" class="short" />
			 </div>
				  <div style="margin-top:8px;"><label style="cursor:pointer;">
   		    		     <input type="checkbox" id="ignoreQuestionableFranchises" checked>Ignorar jogadores com status "Questionable"
				  </label></div>
        			  <div class=row>
          			      <input id="onlyFailing" type="checkbox" /> Somente abaixo do m√≠n.
          			      <button class="primary" onclick="buscarFranchisePlayers()">Varrer Escala√ß√µes</button>
        			   </div>
      		</div>
     </div>	  

     <div class="panel buscas-card">
  		<div class="buscas-header" onclick="toggleTeamBody(this.parentElement)">
        		<h3> Procurar jogadores de Franchise</h3>
		</div>
		<div class="buscas-body" style="display:block;">
    			<div class="brand">   
          			<select id="franchiseTeamSelect"></select>
        		</div>
        		<div class="row" style="margin-top:8px;">
          			<input id="search4LeagueId" type="text" placeholder="League ID (Ex: 1234...)" />
        		</div>
        		<div class="row">
          			<button class="primary" onclick="buscarFranchisePlayersByTeam()">Procurar Jogadores</button>
        		</div>
      		</div>

    </div>

</div>

    <div class="col-center">
      <div class="actions-row" id="franchiseActions" style="display:none;">
        <button class="ghost" id="expandAllBtn">Expandir todos</button>
        <button class="ghost" id="collapseAllBtn">Recolher todos</button>
        <button class="primary" id="exportBtn">Exportar para WhatsApp (Franchises)</button>
      </div>

      <div id="resultado"></div>
    </div>

    <div class="col-right">
      <img src="https://i.ibb.co/xqmb8qqy/jogos-week14.png" width="200" height="470" alt="Jogos Semana 14 - 2025">
      <br> <b>Times de Bye j√° est√£o na imagem</b><br> 
    </div>
  </div>

  <div id="debug-log"><pre id="debugPre"></pre></div>

  <footer>
    <button class="dark-toggle" id="darkToggle">üåô OFF</button>
    <button id="toggleDebug" class="ghost">ü™≤ Debug</button>
    <div id="accessCount">GMs em a√ß√£o: 0</div>
    <div><a href="mailto:scrum.moura@gmail.com">Algo errado? Novas ideias? Manda pra c√°.</a></div>
  </footer>

<script>
/* --------------------------
   Dados est√°ticos: 32 times (nomes completos)
   -------------------------- */
const nflTeams = [
  "Arizona Cardinals","Atlanta Falcons","Baltimore Ravens","Buffalo Bills",
  "Carolina Panthers","Chicago Bears","Cincinnati Bengals","Cleveland Browns",
  "Dallas Cowboys","Denver Broncos","Detroit Lions","Green Bay Packers",
  "Houston Texans","Indianapolis Colts","Jacksonville Jaguars","Kansas City Chiefs",
  "Las Vegas Raiders","Los Angeles Chargers","Los Angeles Rams","Miami Dolphins",
  "Minnesota Vikings","New England Patriots","New Orleans Saints","New York Giants",
  "New York Jets","Philadelphia Eagles","Pittsburgh Steelers","San Francisco 49ers",
  "Seattle Seahawks","Tampa Bay Buccaneers","Tennessee Titans","Washington Commanders"
];

const abbrToFull = {
  ARI: "Arizona Cardinals", ATL: "Atlanta Falcons", BAL: "Baltimore Ravens", BUF: "Buffalo Bills",
  CAR: "Carolina Panthers", CHI: "Chicago Bears", CIN: "Cincinnati Bengals", CLE: "Cleveland Browns",
  DAL: "Dallas Cowboys", DEN: "Denver Broncos", DET: "Detroit Lions", GB: "Green Bay Packers",
  HOU: "Houston Texans", IND: "Indianapolis Colts", JAX: "Jacksonville Jaguars", KC: "Kansas City Chiefs",
  LV: "Las Vegas Raiders", LAC: "Los Angeles Chargers", LAR: "Los Angeles Rams", MIA: "Miami Dolphins",
  MIN: "Minnesota Vikings", NE: "New England Patriots", NO: "New Orleans Saints", NYG: "New York Giants",
  NYJ: "New York Jets", PHI: "Philadelphia Eagles", PIT: "Pittsburgh Steelers", SF: "San Francisco 49ers",
  SEA: "Seattle Seahawks", TB: "Tampa Bay Buccaneers", TEN: "Tennessee Titans", WSH: "Washington Commanders",
  WAS: "Washington Commanders"
};

/* bye weeks map (from your second file) */
const byeWeeks = {
  5: ["ATL", "CHI", "GB", "PIT"],
  6: ["HOU", "MIN"],
  7: ["BAL", "BUF"],
  8: ["ARI", "DET", "JAX", "LV", "LAR", "SEA"],
  9: ["CLE", "NYJ", "PHI", "TB"],
  10: ["CIN", "DAL", "KC", "TEN"],
  11: ["IND", "NO"],
  12: ["DEN", "LAC", "MIA", "WAS"],
  14: ["CAR", "NE", "NYG", "SF"]
};

/* helpers */
function normalizeName(s){ if(!s) return ""; return String(s).toLowerCase().replace(/[^a-z0-9]/g,""); }
function matchTeamByName(name){
  if(!name) return "";
  const n = normalizeName(name);
  for(const t of nflTeams){ if(normalizeName(t).includes(n) || n.includes(normalizeName(t))) return t; }
  return name;
}
function abbrToFullName(abbr){ if(!abbr) return ""; return abbrToFull[String(abbr).toUpperCase()] || ""; }
function isNoTeamValue(team){ if(team===null || team===undefined) return true; if(typeof team !== "string") return false; const t = team.trim().toUpperCase(); return t==="" || t==="-" || t==="FA" || t==="FREE AGENT"; }

/* UI refs */
const resultado = document.getElementById("resultado");
const franchiseActions = document.getElementById("franchiseActions");
const debugLog = document.getElementById("debug-log");
const debugPre = document.getElementById("debugPre");
let debugOn = false;

/* dark toggle */
document.getElementById("darkToggle").addEventListener("click", ()=>{
  document.body.classList.toggle("dark");
  document.getElementById("darkToggle").textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è ON" : "üåô OFF";
});

document.getElementById("toggleDebug").addEventListener("click", ()=>{
  debugOn = !debugOn;
  debugLog.style.display = debugOn ? "block" : "none";
  document.getElementById("toggleDebug").textContent = debugOn ? "ü™≤ Debug ON" : "ü™≤ Debug";
});

/* access counter */
(function accessCounter(){
  let n = Number(localStorage.getItem("acessosSleeper") || 0);
  n++;
  localStorage.setItem("acessosSleeper", n);
  document.getElementById("accessCount").textContent = `GMs em a√ß√£o: ${n}`;
})();

/* status helpers */
function statusClass(status){
  if(!status) return "status-Healthy";
  if(status === "Out") return "status-Out";
  if(status === "Doubtful") return "status-Doubtful";
  if(status === "Questionable") return "status-Questionable";
  if(status === "IR") return "status-IR";
  if(status === "Suspended") return "status-Suspended";
  return "status-Healthy";
}
function getColorForStatus(status){
  switch(status){
    case "Out": return "#b71c1c";
    case "Doubtful": return "#FF5C00";
    case "Questionable": return "#FFBF00";
    case "IR": return "#6a1b9a";
    case "Suspended": return "#424242";
    default: return "#2e7d32";
  }
}

/* fetch util */
async function safeFetchJson(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
  return await res.json();
}

/* get current week via API state */
async function getCurrentWeek(){
  try{
    const s = await safeFetchJson("https://api.sleeper.app/v1/state/nfl");
    return s && (s.week || s.leg || s.season_week) ? (s.week || s.leg || s.season_week) : null;
  }catch(e){
    console.warn("N√£o foi poss√≠vel obter semana atual:", e);
    return null;
  }
}

/* build franchise team select (search 4) */
(function populateTeamSelect(){
  const s = document.getElementById("franchiseTeamSelect");
  nflTeams.forEach(t => {
    const o = document.createElement("option");
    o.value = t;
    o.textContent = t;
    s.appendChild(o);
  });
})();

/* detectEmptyPositions (kept) */
function detectEmptyPositions(starters = [], players = {}, rosterPositions = null, league = null) {
  if ((!Array.isArray(rosterPositions) || rosterPositions.length === 0) && league) {
    rosterPositions = league.roster_positions 
      || league.metadata?.roster_positions 
      || league.settings?.roster_positions 
      || [];
  }
  if (!Array.isArray(rosterPositions) || rosterPositions.length === 0) {
    rosterPositions = Array.from({ length: Math.max(1, starters.length) }, (_, i) => `Slot ${i + 1}`);
  }
  const emptySlots = [];
  for (let i = 0; i < rosterPositions.length; i++) {
    const slotName = rosterPositions[i] || `Slot ${i + 1}`;
    const pid = starters[i];
    if (slotName === "BN" || slotName === "IR") continue;
    const isEmpty = !pid || !players[pid];
    if (isEmpty) {
      emptySlots.push({ index: i, name: slotName });
    }
  }
  return { countEmpty: emptySlots.length, emptySlots };
}

/* -------------------
   BUSCAR POR USU√ÅRIO
   - Injuries (status != Healthy)
   - Bye week (pela semana atual + mapa byeWeeks)
   - Sem time (FA, null, "")
   - Debug com mapeamentos e player_ids n√£o encontrados
   ------------------- */
async function buscarPorUsuario(){
  const username = document.getElementById("username").value.trim();
  const ignoreQuestionable = document.getElementById("ignoreQuestionable").checked;
  document.getElementById("franchiseActions").style.display = "none";
  resultado.innerHTML = `<div class="panel">Buscando usu√°rio ${username}...</div>`;
  if(!username){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe um nome de usu√°rio.</div>`; return; }

  try{
    const userData = await safeFetchJson(`https://api.sleeper.app/v1/user/${username}`);
    if(!userData || !userData.user_id){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Usu√°rio n√£o encontrado.</div>`; return; }

    // fetch leagues + players + week
    const [leagues, playersObj, currentWeek] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/user/${userData.user_id}/leagues/nfl/${new Date().getFullYear()}`),
      (async ()=>{ try{ return await safeFetchJson("https://api.sleeper.app/v1/players/nfl"); } catch(e){ return {}; } })(),
      getCurrentWeek()
    ]);
    const players = playersObj || {};
    resultado.innerHTML = "";

    const fantasyLeagues = (leagues || []).filter(l => l.settings && [0,1,2,3].includes(l.settings.type));
    // prepare global debug accumulator
    let globalDebug = {
      user: username,
      user_id: userData.user_id,
      week: currentWeek,
      leagues: []
    };
    const teamsOnBye = currentWeek && byeWeeks[currentWeek] ? byeWeeks[currentWeek] : [];

    for(const league of fantasyLeagues){
      try{
        const rosters = await safeFetchJson(`https://api.sleeper.app/v1/league/${league.league_id}/rosters`);
        const roster = (rosters||[]).find(r => r.owner_id === userData.user_id || r.co_owner_id === userData.user_id || (Array.isArray(r.owner_ids) && r.owner_ids.includes(userData.user_id)));
        if(!roster) continue;

        const rosterPositions = (league?.settings?.roster_positions) || null;
        const starters = roster.starters || [];
        // arrays to collect categories
        const injured = [];
        const byePlayers = [];
        const noTeamPlayers = [];
        const notFound = [];
        const mappingIdToName = [];

        for(const rawPid of starters){
          const pid = String(rawPid);
          let p = players[pid];
          if(!p){
            // try individual fetch as fallback
            try { p = await safeFetchJson(`https://api.sleeper.app/v1/player/${pid}`); } catch(e){ p = null; }
          }
          mappingIdToName.push({ pid, name: p ? (p.full_name || p.display_name || "‚Äî") : "N√ÉO ENCONTRADO" });
          if(!p){
            notFound.push(pid);
            continue;
          }
          // sem time?
          if(isNoTeamValue(p.team)){
            noTeamPlayers.push({ pid, name: p.full_name || "‚Äî", position: p.position || p.position_type || "-", team: "Sem Time" });
            continue;
          }
          // bye?
          const team = String(p.team).toUpperCase();
          if(teamsOnBye.includes(team)){
            byePlayers.push({ pid, name: p.full_name || "‚Äî", position: p.position || "-", team });
          }
          // injury status
        if (p.injury_status && p.injury_status !== "Healthy") {
 			 // Se o usu√°rio optou por ignorar "Questionable", pula esses jogadores
  				if (ignoreQuestionable && p.injury_status === "Questionable") continue;
  					injured.push(p);
	}

        } // end for starters

        // detect empties
        const empties = detectEmptyPositions(starters, players, rosterPositions, league);

        // build card
        const card = document.createElement("div"); card.className = "team-card";
        const header = document.createElement("div"); header.className = "team-header";
        const ownerName = roster.owner_id ? (roster.owner_id === userData.user_id ? (userData.display_name || username) : roster.owner_id) : "GM desconhecido";
        const teamDetected = matchTeamByName(roster.metadata?.team_name || league.name || ownerName);
        header.innerHTML = `
          <div class="left">
            <div>
              <div class="team-title">${teamDetected} ‚Äî Liga ID: ${league.league_id}</div>
              <div class="team-meta">${league.name}</div>
            </div>
          </div>
          <div class="team-badges right">
            <div class="team-badge inj">${injured.length}</div>
            <div class="team-badge bye">${byePlayers.length}</div>
            <div class="team-badge notime">${noTeamPlayers.length}</div>
            <div style="margin-left:8px;">
              <button class="copy-btn" title="Copiar League ID" onclick="copyLeagueId(this,'${league.league_id}')">
                <span class="ico">üìã</span>
              </button>
            </div>
          </div>
        `;
        header.addEventListener("click", ()=> toggleTeamBody(card));

        const body = document.createElement("div"); body.className = "team-body";
        // empties alert
        if(empties.countEmpty > 0){
          const names = empties.emptySlots.map(s => s.name || 'Posi√ß√£o sem jogador').join(', ');
          const emptyDiv = document.createElement("div");
          emptyDiv.className = "empty-pos";
          emptyDiv.textContent = `Alerta de ${empties.countEmpty} Posi√ß√µes sem Jogador escalado: ${names}`;
          body.appendChild(emptyDiv);
        }

        // Summaries
        if(injured.length === 0 && byePlayers.length === 0 && noTeamPlayers.length === 0){
          const s = document.createElement("div"); s.className = "summary"; s.textContent = "Nenhum titular em bye, sem time ou com status diferente de Healthy nesta liga.";
          body.appendChild(s);
        } else {
          body.style.display = "block";

          if(injured.length > 0){
            const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares com status duvidoso:";
            body.appendChild(title);
            for(const p of injured){
              const pl = document.createElement("div"); pl.className = "player-card";
              pl.innerHTML = `
                <div class="player-left">
                  <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                  <div>
                    <div class="player-name">${p.full_name}</div>
                    <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || "FA"}</div>
                  </div>
                </div>
                <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
              `;
              body.appendChild(pl);
            }
          }

          if(byePlayers.length > 0){
            const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares em Bye Week:";
            body.appendChild(title);
            for(const p of byePlayers){
              const pl = document.createElement("div"); pl.className = "player-card";
              pl.innerHTML = `
                <div class="player-left">
                  <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus('') }"></div>
                  <div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                  </div>
                </div>
                <div style="font-size:12px;color:var(--muted)">${p.team}</div>
              `;
              body.appendChild(pl);
            }
          }

          if(noTeamPlayers.length > 0){
            const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares sem time vinculado:";
            body.appendChild(title);
            for(const p of noTeamPlayers){
              const pl = document.createElement("div"); pl.className = "player-card";
              pl.innerHTML = `
                <div class="player-left">
                  <div style="width:8px;height:40px;border-radius:6px;background:#9e9e9e"></div>
                  <div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || "Sem Time"}</div>
                  </div>
                </div>
                <div style="font-size:12px;color:var(--muted)">Sem time</div>
              `;
              body.appendChild(pl);
            }
          }
        }

        card.appendChild(header); card.appendChild(body);
        resultado.appendChild(card);

        // accumulate debug info per league
        globalDebug.leagues.push({
          league_id: league.league_id,
          league_name: league.name,
          injured_count: injured.length,
          bye_count: byePlayers.length,
          no_team_count: noTeamPlayers.length,
          not_found: notFound,
          mapping: mappingIdToName
        });

      } catch(errInner){
        console.warn("Erro ao processar liga", league.league_id, errInner);
      }
    } // end for leagues

    // show debug info if enabled
    if(debugOn){
      debugPre.textContent = JSON.stringify(globalDebug, null, 2);
      debugLog.style.display = "block";
    } else {
      // keep debug hidden but still populate content for when user activates
      debugPre.textContent = JSON.stringify(globalDebug, null, 2);
    }

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar usu√°rio.</div>`;
    if(debugOn) { debugPre.textContent = String(err.stack || err); debugLog.style.display = "block"; }
  }
}

/* copy LeagueID icon handler */
function copyLeagueId(btn, leagueId){
  navigator.clipboard.writeText(leagueId).then(()=>{
    let toast = btn.querySelector('.copy-toast');
    if(!toast){
      toast = document.createElement('div'); toast.className = 'copy-toast';
      toast.textContent = 'ID copiado';
      btn.appendChild(toast);
    }
    toast.style.display = 'block';
    setTimeout(()=>{ toast.style.display = 'none'; }, 1400);
  }).catch(()=> alert('N√£o foi poss√≠vel copiar o League ID automaticamente.'));
}

/* rest of original functions kept (buscarPorLiga, buscarFranchisePlayers, buscarFranchisePlayersByTeam, export) */
/* To keep this merged file concise I will include the previously existing functions by re-using their definitions from the original file. */
/* For brevity and safety these functions are appended unchanged from your base file. */

// --- START paste of original helper functions (buscarPorLiga, buscarFranchisePlayers, buscarFranchisePlayersByTeam, exportFranchiseWhatsApp, toggleTeamBody)
// Note: these are included verbatim from your base file so existing behavior is preserved.
/* ----------------------------------------
   2) Buscar por League ID (com Bye Week)
   ---------------------------------------- */
async function buscarPorLiga() {
  const leagueId = document.getElementById("leagueId").value.trim();
  const ignoreQuestionable = document.getElementById("ignoreQuestionableLeague").checked;
  document.getElementById("franchiseActions").style.display = "none";
  resultado.innerHTML = `<div class="panel">Buscando liga ${leagueId}...</div>`;
  if (!leagueId) {
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe um League ID.</div>`;
    return;
  }

  try {
    // ‚ûï Obtem a semana atual e define times em bye
    const currentWeek = await getCurrentWeek();
    const teamsOnBye = currentWeek && byeWeeks[currentWeek] ? byeWeeks[currentWeek] : [];

    const [leagueObj, users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson(`https://api.sleeper.app/v1/players/nfl`)
    ]);

    const players = playersObj || {};
    const rosterPositions = leagueObj?.settings?.roster_positions || null;

    const userMap = {};
    (users || []).forEach(u => {
      userMap[u.user_id] = {
        name: u.display_name || "Time sem dono",
        teamMeta: u.metadata?.team_name || ""
      };
    });

    resultado.innerHTML = "";

    for (const r of (rosters || [])) {
      const owner = userMap[r.owner_id] || { name: "Time sem dono", teamMeta: "" };
      const teamNameRaw = r.metadata?.team_name || owner.teamMeta || owner.name || "Sem nome definido";
      const detected = matchTeamByName(teamNameRaw) || teamNameRaw;

      const starters = (r.starters || []);
      const injuredPlayers = [];
      const byePlayers = []; // ‚ûï novo array
      const noTeamPlayers = []; // opcional se quiser integrar depois

      for (const pid of starters) {
        const p = players[pid];
        if (!p) continue;

        // ‚ûï Detectar jogadores em bye
        const team = String(p.team).toUpperCase();
        if (teamsOnBye.includes(team)) {
          byePlayers.push({ pid, name: p.full_name || "‚Äî", position: p.position || "-", team });
        }

        // Lesionados (mantido)
        if (p.injury_status && p.injury_status !== "Healthy") {
          if (ignoreQuestionable && p.injury_status === "Questionable") continue;
          injuredPlayers.push(p);
        }
      }

      const empties = detectEmptyPositions(starters, players, rosterPositions, leagueObj);

      const card = document.createElement("div"); card.className = "team-card";
      const header = document.createElement("div"); header.className = "team-header";
      header.innerHTML = `
        <div class="left">
          <div>
            <div class="team-title">${detected} ‚Äî ${owner.name}</div>
            <div class="team-meta">${teamNameRaw ? `meta: ${teamNameRaw}` : 'sem metadata'}</div>
          </div>
        </div>
        <div class="team-badges right">
          <div class="team-badge bye">${byePlayers.length}</div> <!-- ‚ûï contagem de bye -->
          <div class="team-badge inj">${injuredPlayers.length}</div>

        </div>
      `;
      header.addEventListener("click", () => toggleTeamBody(card));

      const body = document.createElement("div"); body.className = "team-body";

      if (empties.countEmpty > 0) {
        const names = empties.emptySlots.map(s => s.name || 'Posi√ß√£o sem jogador').join(', ');
        const emptyDiv = document.createElement("div");
        emptyDiv.className = "empty-pos";
        emptyDiv.textContent = `Alerta de ${empties.countEmpty} Posi√ß√µes sem Jogador escalado: ${names}`;
        body.appendChild(emptyDiv);
      }

      if (injuredPlayers.length === 0 && byePlayers.length === 0) {
        body.innerHTML += `<div class="summary">Nenhum titular lesionado ou em bye week.</div>`;
      } else {
        body.style.display = "block";

        // ‚ûï Jogadores lesionados
        if (injuredPlayers.length > 0) {
          const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares com status duvidoso:";
          body.appendChild(title);
          for (const p of injuredPlayers) {
            const pl = document.createElement("div"); pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || "FA"}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
            `;
            body.appendChild(pl);
          }
        }

        // ‚ûï Jogadores em bye
        if (byePlayers.length > 0) {
          const title = document.createElement("div"); title.className = "group-title"; title.textContent = "Titulares em Bye Week:";
          body.appendChild(title);
          for (const p of byePlayers) {
            const pl = document.createElement("div"); pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus('')}"></div>
                <div>
                  <div class="player-name">${p.name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team}</div>
                </div>
              </div>
              <div style="font-size:12px;color:var(--muted)">${p.team}</div>
            `;
            body.appendChild(pl);
          }
        }
      }

      card.appendChild(header);
      card.appendChild(body);
      resultado.appendChild(card);
    }

  } catch (err) {
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar dados da liga. Verifique o League ID.</div>`;
  }
}

/* ----------------------------------------
   3) Buscar Franchise Players (por liga)
   ---------------------------------------- */
async function buscarFranchisePlayers(){
  const leagueId = document.getElementById("franchiseLeagueId").value.trim();
  const ignoreQuestionable = document.getElementById("ignoreQuestionableFranchises").checked;
  const minFranchiseRaw = document.getElementById("minFranchise").value.trim();
  const minFranchise = parseInt(minFranchiseRaw || "0", 10);
  const onlyFailing = document.getElementById("onlyFailing").checked;
  const currentWeek = await getCurrentWeek();
  const teamsOnBye = currentWeek && byeWeeks[currentWeek] ? byeWeeks[currentWeek] : [];

  resultado.innerHTML = `<div class="panel">Buscando franquias na liga ${leagueId}...</div>`;
  if(!leagueId || !minFranchiseRaw){
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe League ID e n√∫mero m√≠nimo.</div>`;
    return;
  }

  try {
    const [leagueObj, users, rosters, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson("https://api.sleeper.app/v1/players/nfl")
    ]);

    const players = playersObj || {};
    const rosterPositions = leagueObj?.settings?.roster_positions || null;

    const userMap = {};
    (users||[]).forEach(u => {
      userMap[u.user_id] = {
        name: u.display_name || "Time sem dono",
        userTeamMeta: u.metadata?.team_name || ""
      };
    });

    const enriched = (rosters || []).map(r => {
      const owner = userMap[r.owner_id] || {name:"Time sem dono", userTeamMeta:""};
      const rawMeta = r.metadata?.team_name || owner.userTeamMeta || owner.name || "";
      let detected = matchTeamByName(rawMeta);
      const starters = (r.starters || []).map(id => players[id]).filter(Boolean);

      if(!detected){
        const counts = {};
        for(const p of starters){ if(!p || !p.team) continue; counts[p.team] = (counts[p.team]||0)+1; }
        let bestAbbr="", bestCount=0;
        for(const k in counts){ if(counts[k] > bestCount){ bestAbbr = k; bestCount = counts[k]; } }
        if(bestAbbr){ detected = abbrToFullName(bestAbbr) || bestAbbr; }
      }
      if(!detected) detected = rawMeta || owner.name || "Franquia sem nome";

      const franchiseStarters = [];
      for(const p of starters){
        const pFull = abbrToFullName(p.team) || p.team || "";
        if(normalizeName(pFull) === normalizeName(detected) ||
           normalizeName(pFull).includes(normalizeName(detected)) ||
           normalizeName(detected).includes(normalizeName(pFull))){
          franchiseStarters.push(p);
        }
      }

      const healthyFranchise = franchiseStarters.filter(p=>!p.injury_status || p.injury_status === "Healthy").length;
      const franchiseCount = franchiseStarters.length;
      const injuredOverall = starters.filter(p => {
        if (!p.injury_status || p.injury_status === "Healthy") return false;
        if (ignoreQuestionable && p.injury_status === "Questionable") return false;
        return true;
      }).length;

      return { roster: r, owner, rawMeta, detected, starters, franchiseStarters, franchiseCount, healthyFranchise, injuredOverall };
    });

    enriched.sort((a,b) => (a.detected || "").localeCompare(b.detected || ""));
    resultado.innerHTML = "";
    if(franchiseActions) franchiseActions.style.display = "flex";

    for(const en of enriched){
      const healthyFranchise = en.healthyFranchise;
      if(onlyFailing && healthyFranchise >= minFranchise) continue;

      const r = en.roster, owner = en.owner;
      const franchiseName = en.detected;
      const rawStartersIds = en.roster.starters || [];

      const card = document.createElement("div");
      card.className = "team-card";

      const header = document.createElement("div");
      header.className = "team-header";
      header.innerHTML = `
        <div class="left">
          <div>
            <div class="team-title">${franchiseName} ‚Äî ${owner.name}</div>
            <div class="team-meta">${en.rawMeta ? `meta: ${en.rawMeta}` : ''}</div>
          </div>
        </div>
        <div class="team-badges right">
          <div class="team-badge franchise" data-franchise-count>${en.franchiseCount}</div>
          <div class="team-badge inj" data-injured-count>${en.injuredOverall}</div>
          <div class="team-badge bye" data-bye-count>0</div> <!-- üÜï Contador de jogadores em bye -->
        </div>
      `;
      header.addEventListener("click", ()=>toggleTeamBody(card));

      const body = document.createElement("div");
      body.className = "team-body";

      const franchiseRow = document.createElement("div");
      franchiseRow.style.marginBottom = "8px";
      franchiseRow.innerHTML = `
        <label style="font-weight:700;margin-right:8px;">Nome da Franquia (edite se necess√°rio):</label>
        <input type="text" class="team-input" value="${franchiseName}" style="padding:6px 8px;border-radius:6px;border:1px solid #ccc;width:60%;" />
      `;
      body.appendChild(franchiseRow);

      const containerPlayers = document.createElement("div");
      containerPlayers.className = "players-list";
      body.appendChild(containerPlayers);

      async function recompute(){
        containerPlayers.innerHTML = "";

        const franchiseVal = (franchiseRow.querySelector(".team-input").value || "").trim();
        let franchiseFull = franchiseVal;
        if(franchiseVal && franchiseVal.length <= 3){
          const mapped = abbrToFullName(franchiseVal.toUpperCase());
          if(mapped) franchiseFull = mapped;
        } else {
          const matched = matchTeamByName(franchiseVal);
          if(matched) franchiseFull = matched;
        }
        if(!franchiseFull) franchiseFull = franchiseName;

        const franchiseStartersNow = [];
        const byePlayers = []; // üÜï jogadores em bye

        for(const p of en.starters){
          const pFull = abbrToFullName(p.team) || p.team || "";
          const team = String(p.team || "").toUpperCase();

          // Detec√ß√£o da franquia
          if(normalizeName(pFull) === normalizeName(franchiseFull) ||
             normalizeName(pFull).includes(normalizeName(franchiseFull)) ||
             normalizeName(franchiseFull).includes(normalizeName(pFull))){
            franchiseStartersNow.push(p);
          }

          // üÜï Detec√ß√£o de jogadores em bye
          if(teamsOnBye.includes(team)){
            byePlayers.push(p);
          }
        }

        const healthyFrNow = franchiseStartersNow.filter(p=>!p.injury_status || p.injury_status === "Healthy").length;
        const franchiseCountNow = franchiseStartersNow.length;

        const nonHealthyStarters = en.starters.filter(p => {
          if (!p.injury_status || p.injury_status === "Healthy") return false;
          if (ignoreQuestionable && p.injury_status === "Questionable") return false;
          return true;
        });

        const emptiesLocal = detectEmptyPositions(rawStartersIds, (awaitPlayersSnapshot()), leagueObj?.settings?.roster_positions);
        if(emptiesLocal.countEmpty > 0){
          const names = emptiesLocal.emptySlots.map(s => s.name || 'Posi√ß√£o sem jogador').join(', ');
          const emptyDiv = document.createElement("div");
          emptyDiv.className = "empty-pos";
          emptyDiv.textContent = `Alerta de ${emptiesLocal.countEmpty} Posi√ß√µes sem Jogador escalado: ${names}`;
          containerPlayers.appendChild(emptyDiv);
        }

        // Atualiza badges
        const frBadge = header.querySelector("[data-franchise-count]");
        const injBadge = header.querySelector("[data-injured-count]");
        const byeBadge = header.querySelector("[data-bye-count]");
        if(frBadge) frBadge.textContent = franchiseCountNow;
        if(injBadge) injBadge.textContent = nonHealthyStarters.length;
        if(byeBadge) byeBadge.textContent = byePlayers.length;

        const summary = document.createElement("div");
        summary.className = "summary";
        summary.innerHTML = `Titulares da franquia identificados: <strong>${franchiseCountNow}</strong> ‚Äî Saud√°veis: <strong>${healthyFrNow}</strong> (m√≠nimo: <strong>${minFranchise}</strong>)`;
        containerPlayers.appendChild(summary);

        const statusLine = document.createElement("div");
        statusLine.style.marginTop = "6px";
        if(healthyFrNow >= minFranchise){
          statusLine.innerHTML = `<div style="color:var(--ok);font-weight:800;margin-top:6px;">‚úÖ Bom trabalho ‚Äî franquia atende o m√≠nimo.</div>`;
        } else {
          const falta = minFranchise - healthyFrNow;
          statusLine.innerHTML = `<div style="color:var(--bad);font-weight:800;margin-top:6px;">‚ö†Ô∏è Franquia em Risco ‚Äî faltam <strong>${falta}</strong> titulares saud√°veis.</div>`;
        }
        containerPlayers.appendChild(statusLine);

        // Se√ß√£o de lesionados
        if(nonHealthyStarters.length > 0){
          const title = document.createElement("div");
          title.className = "group-title";
          title.textContent = "Titulares com status duvidoso:";
          containerPlayers.appendChild(title);

          const nonList = document.createElement("div");
          nonList.className = "nonhealthy-list";
          for(const p of nonHealthyStarters){
            const pl = document.createElement("div");
            pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status}</div></div>
            `;
            nonList.appendChild(pl);
          }
          containerPlayers.appendChild(nonList);
        }

        // üÜï Se√ß√£o de jogadores em bye
        if(byePlayers.length > 0){
          const title = document.createElement("div");
          title.className = "group-title";
          title.textContent = "Titulares em Bye Week:";
          containerPlayers.appendChild(title);

          const byeList = document.createElement("div");
          byeList.className = "bye-list";
          for(const p of byePlayers){
            const pl = document.createElement("div");
            pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:var(--muted)"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill bye">BYE</div></div>
            `;
            byeList.appendChild(pl);
          }
          containerPlayers.appendChild(byeList);
        }

        // Titulares da franquia
        const frTitle = document.createElement("div");
        frTitle.className = "group-title";
        frTitle.textContent = "Titulares pertencentes √† franquia:";
        containerPlayers.appendChild(frTitle);

        const frList = document.createElement("div");
        frList.className = "franchise-list";
        if(franchiseStartersNow.length > 0){
          for(const p of franchiseStartersNow){
            const pl = document.createElement("div");
            pl.className = "player-card";
            pl.innerHTML = `
              <div class="player-left">
                <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
                <div>
                  <div class="player-name">${p.full_name}</div>
                  <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
                </div>
              </div>
              <div><div class="status-pill ${statusClass(p.injury_status)}">${p.injury_status || "Healthy"}</div></div>
            `;
            frList.appendChild(pl);
          }
        } else {
          const none = document.createElement("div");
          none.style.marginTop="8px";
          none.textContent = "Nenhum titular da franquia foi identificado entre os starters.";
          frList.appendChild(none);
        }
        containerPlayers.appendChild(frList);

        card.dataset.franchiseCount = franchiseCountNow;
        card.dataset.healthyFranchise = healthyFrNow;
        card.dataset.injuredOverall = nonHealthyStarters.length;

        if(nonHealthyStarters.length > 0 || healthyFrNow < minFranchise || byePlayers.length > 0){
          body.style.display = "block";
        } else {
          body.style.display = "none";
        }
      } // end recompute

      function awaitPlayersSnapshot(){
        return players;
      }

      recompute();
      const inputEl = franchiseRow.querySelector(".team-input");
      inputEl.addEventListener("change", recompute);
      inputEl.addEventListener("keyup", (e)=>{ if(e.key === "Enter") recompute(); });

      card.appendChild(header);
      card.appendChild(body);
      resultado.appendChild(card);
    }

    document.getElementById("expandAllBtn").onclick = ()=> { document.querySelectorAll(".team-body").forEach(b=>b.style.display="block"); };
    document.getElementById("collapseAllBtn").onclick = ()=> { document.querySelectorAll(".team-body").forEach(b=>b.style.display="none"); };
    document.getElementById("exportBtn").onclick = ()=> exportFranchiseWhatsApp(minFranchise);

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar franquias. Verifique par√¢metros e League ID.</div>`;
  }
}

/* ----------------------------------------
   4) Procurar jogadores de franquia (por time + league)
   ---------------------------------------- */
async function buscarFranchisePlayersByTeam(){
  const teamName = document.getElementById("franchiseTeamSelect").value;
  const leagueId = document.getElementById("search4LeagueId").value.trim();
  resultado.innerHTML = `<div class="panel">Buscando jogadores da franquia ${teamName} na liga ${leagueId}...</div>`;
  if(!leagueId){ resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Informe o League ID.</div>`; return; }

  try{
    const [leagueObj, rosters, users, playersObj] = await Promise.all([
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/rosters`),
      safeFetchJson(`https://api.sleeper.app/v1/league/${leagueId}/users`),
      safeFetchJson(`https://api.sleeper.app/v1/players/nfl`)
    ]);
    const players = playersObj || {};
    const rosterPositions = leagueObj?.settings?.roster_positions || null;
    const roster_positions_set = new Set((rosterPositions||[]).map(p=>p.toUpperCase()));

    const ownerMap = {};
    for(const r of (rosters||[])){
      (r.players || []).forEach(pid => { ownerMap[pid] = r.owner_id; });
    }
    const rosterPlayerIds = new Set();
    (rosters||[]).forEach(r => { (r.players||[]).forEach(pid => rosterPlayerIds.add(String(pid))); });

    const userMap = {};
    (users||[]).forEach(u => userMap[u.user_id] = { name: u.display_name || "Time sem dono" });

    const teamAbbrs = Object.keys(abbrToFull).filter(k => abbrToFull[k] === teamName).length ? 
      Object.keys(abbrToFull).filter(k => abbrToFull[k] === teamName) : [];
    const matchedPlayers = [];

    for (const pid in players) {
      const p = players[pid];
      if (!p) continue;
      const playerTeamAbbr = (p.team || "").toUpperCase();
      if (!playerTeamAbbr) continue;
      const playerTeamFull = abbrToFullName(playerTeamAbbr);
      const matches =
        playerTeamAbbr === Object.keys(abbrToFull).find(k => abbrToFull[k] === teamName) ||
        playerTeamFull === teamName;
      if (matches) {
        matchedPlayers.push({ id: pid, player: p });
      }
    }

    const rostered = [], freeAgents = [];
    for(const mp of matchedPlayers){
      const pid = String(mp.id);
      if(rosterPlayerIds.has(pid)) rostered.push(mp);
      else freeAgents.push(mp);
    }

    function ownerNameFor(pid){
      const ownerId = ownerMap[pid];
      if(!ownerId) return null;
      return userMap[ownerId]?.name || ownerId || "GM desconhecido";
    }

    function isPositionScorable(pos){
      if(!pos) return true;
      if(!roster_positions_set.size) return true;
      const up = String(pos || "").toUpperCase();
      return roster_positions_set.has(up) || roster_positions_set.has(up.substring(0,2));
    }

    const roFiltered = rostered.filter(rp => isPositionScorable(rp.player.position));
    const freeFiltered = freeAgents.filter(rp => isPositionScorable(rp.player.position));

    const attackPositions = new Set(['QB','RB','WR','TE','FB','RB/WR','WR/RB']);
    const kickerPositions = new Set(['K','PK']);
    const defensePositions = new Set(['DL','LB','DB','CB','S','DE','DT','EDGE','CB/S','DB/S','LB/ILB','DB']);

    function positionRank(pos){
      if(!pos) return 4;
      const up = pos.toUpperCase();
      if(attackPositions.has(up)) return 1;
      if(kickerPositions.has(up)) return 2;
      if(defensePositions.has(up)) return 3;
      return 1;
    }

    function sortPlayers(arr){
      return arr.sort((a,b)=>{
        const pa = a.player.position || '';
        const pb = b.player.position || '';
        const ra = positionRank(pa), rb = positionRank(pb);
        if(ra !== rb) return ra - rb;
        const na = String(a.player.full_name || '').localeCompare(String(b.player.full_name || ''));
        return na;
      });
    }

    const roSorted = sortPlayers(roFiltered);
    const freeSorted = sortPlayers(freeFiltered);

    resultado.innerHTML = "";
    const panel = document.createElement("div"); panel.className = "panel";
    panel.innerHTML = `<h3>Franquia: ${teamName} ‚Äî Liga ${leagueId}</h3>`;
    resultado.appendChild(panel);

    const rosterSection = document.createElement("div");
    rosterSection.className = "panel";
    rosterSection.innerHTML = `<h4>Jogadores em times (rostered): ${roSorted.length}</h4>`;
    if(roSorted.length === 0){
      rosterSection.innerHTML += `<div style="color:var(--muted)">Nenhum jogador da franquia encontrado em rosters desta liga.</div>`;
    } else {
      roSorted.forEach(item => {
        const p = item.player;
        const pid = item.id;
        const ownerName = ownerNameFor(pid) || 'Livre';
        const card = document.createElement("div"); card.className = "player-card";
        card.innerHTML = `
          <div class="player-left">
            <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
            <div>
              <div class="player-name">${p.full_name}</div>
              <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">${ownerName}</div>
            <div style="font-size:12px;color:var(--muted)">${p.injury_status || 'Healthy'}</div>
          </div>
        `;
        rosterSection.appendChild(card);
      });
    }
    resultado.appendChild(rosterSection);

    const freeSection = document.createElement("div");
    freeSection.className = "panel";
    freeSection.innerHTML = `<h4>Jogadores livres (Free Agents) da franquia: ${freeSorted.length}</h4>`;
    if(freeSorted.length === 0){
      freeSection.innerHTML += `<div style="color:var(--muted)">Nenhum jogador livre da franquia encontrado (ou posi√ß√µes n√£o escal√°veis foram ignoradas).</div>`;
    } else {
      freeSorted.forEach(item => {
        const p = item.player;
        const pid = item.id;
        const card = document.createElement("div"); card.className = "player-card";
        card.innerHTML = `
          <div class="player-left">
            <div style="width:8px;height:40px;border-radius:6px;background:${getColorForStatus(p.injury_status)}"></div>
            <div>
              <div class="player-name">${p.full_name}</div>
              <div class="player-pos">${p.position || "?"} ‚Äî ${p.team || ""}</div>
            </div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:700">Livre</div>
            <div style="font-size:12px;color:var(--muted)">${p.injury_status || 'Healthy'}</div>
          </div>
        `;
        freeSection.appendChild(card);
      });
    }
    resultado.appendChild(freeSection);

  } catch(err){
    console.error(err);
    resultado.innerHTML = `<div class="panel" style="color:var(--bad)">Erro ao buscar jogadores da franquia. Verifique o League ID e o time selecionado.</div>`;
  }
}

/* helper to toggle team body */
function toggleTeamBody(el) {
  const body = el.querySelector(".team-body, .updates-body, .buscas-body");
  if (!body) return;
  const isOpen = body.style.display === "block" || el.classList.contains("open");

  // Alterna visibilidade
  if (isOpen) {
    body.style.display = "none";
    el.classList.remove("open");
  } else {
    body.style.display = "block";
    el.classList.add("open");
  }
}

// --- END pasted functions ---

</script>
</body>
</html>
